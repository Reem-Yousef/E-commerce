<div class="product-detail-container" *ngIf="!loading && product">
  <div class="container-fluid">
    <app-cart-notification></app-cart-notification>

    <div class="product-main">
      <div class="product-images">
        <div class="main-image">
          <img
            [src]="product.images[selectedImageIndex]"
            [alt]="product.name"
            class="main-product-image"
          />
        </div>

        <div class="image-thumbnails" *ngIf="product.images.length > 1">
          <img
            *ngFor="let image of product.images; let i = index"
            [src]="image"
            [alt]="product.name"
            [class.active]="i === selectedImageIndex"
            (click)="selectImage(i)"
            class="thumbnail"
          />
        </div>
      </div>

      <div class="product-info">
        <nav class="breadcrumb">
          <a
            *ngFor="let crumb of breadcrumbs; let last = last"
            [routerLink]="crumb.link || null"
            [class.active]="last"
          >
            {{ crumb.label }}
            <span *ngIf="!last" class="separator">/</span>
          </a>
        </nav>

        <div class="product-header">
          <h1 class="product-title">{{ product.name }}</h1>
          <div class="product-price">
            <span class="current-price"
              >${{ product.price.toFixed(2)
              }}<span class="_Shipping">& Free Shipping</span></span
            >
          </div>
        </div>

        <div class="product-description">
          <p>{{ product.shortDescription || product.description }}</p>
        </div>

        <div class="product-meta">
          <div class="rating-section">
            <div class="category-info">
              <span class="label">Category:</span>
              <span class="value">{{ product.category }}</span>
            </div>
          </div>
          <div class="purchase-section">
            <div class="quan-addBtn">
              <div class="quantity-selector">
                <!-- <button
                  (click)="decreaseQuantity()"
                  [disabled]="quantity <= 1 || isAddingToCart"
                >
                  -
                </button> -->
                <input
                  type="number"
                  [(ngModel)]="quantity"
                  min="1"
                  [readonly]="isAddingToCart"
                />
                <!-- <button
                  (click)="increaseQuantity()"
                  [disabled]="isAddingToCart"
                >
                  +
                </button> -->
              </div>

              <button
                class="add-to-cart-btn"
                [disabled]="!product.inStock || isAddingToCart"
                (click)="addToCartAndViewCart()"
              >
                <span *ngIf="!isAddingToCart">
                  {{ product.inStock ? "Add to cart" : "Out of Stock" }}
                </span>
                <span *ngIf="isAddingToCart"> Adding to cart... </span>
              </button>
            </div>

            <!-- Guaranteed Safe Checkout -->
            <div class="safe-checkout">
              <p class="checkout-title">Guaranteed Safe Checkout</p>
              <div class="payment-icons">
                <img
                  src="../../../assets/images/products/visa.svg"
                  alt="Visa"
                  class="payment-icon"
                />
                <img
                  src="../../../assets/images/products/masterCard.svg"
                  alt="Mastercard"
                  class="payment-icon"
                />
                <img
                  src="../../../assets/images/products/americaExpressCard.svg"
                  alt="American Express"
                  class="payment-icon"
                />
                <img
                  src="../../../assets/images/products/discoverCard.svg"
                  alt="Discover"
                  class="payment-icon"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Product Details Tabs -->
        <div class="product-tabs">
          <div class="tab-headers">
            <button
              [class.active]="activeTab === 'description'"
              (click)="setActiveTab('description')"
              class="tab-header"
            >
              Description
            </button>
            <button
              [class.active]="activeTab === 'reviews'"
              (click)="setActiveTab('reviews')"
              class="tab-header"
            >
              Reviews ({{ reviews.length }})
            </button>
          </div>

          <div class="tab-content">
            <!-- Description Tab -->
            <div *ngIf="activeTab === 'description'" class="tab-panel">
              <div class="description-content">
                <p>{{ product.description }}</p>

                <div *ngIf="product.specifications" class="specifications">
                  <h4>Specifications:</h4>
                  <ul>
                    <li *ngFor="let spec of product.specifications | keyvalue">
                      <strong>{{ spec.key }}:</strong> {{ spec.value }}
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Reviews Tab -->
            <div *ngIf="activeTab === 'reviews'" class="tab-panel">
              <div class="reviews-content">
                <!-- Success Message -->
                <div *ngIf="reviewSubmissionSuccess" class="success-message">
                  <p>
                    ✓ Thank you! Your review has been submitted successfully.
                  </p>
                </div>
                <!-- Existing Reviews -->
                <div *ngIf="reviews.length > 0" class="existing-reviews">
                  <div *ngFor="let review of reviews" class="review-item">
                    <div class="review-header">
                      <span class="reviewer-name">{{ review.userName }}</span>
                      <div class="review-rating">
                        <span
                          *ngFor="let filled of getStarArray(review.rating)"
                          class="star"
                          [class.filled]="filled"
                        >
                          ★
                        </span>
                      </div>
                      <span class="review-date">{{
                        review.date | date : "short"
                      }}</span>
                    </div>
                    <p class="review-comment">{{ review.comment }}</p>
                  </div>
                </div>

                <!-- No Reviews Message -->
                <div
                  *ngIf="
                    !loading &&
                    reviews?.length === 0 &&
                    !reviewSubmissionSuccess
                  "
                  class="no-reviews"
                >
                  <p>There are no reviews yet.</p>
                </div>

                <!-- Review Form Toggle -->
                <div class="review-form-section">
                  <div
                    *ngIf="
                      !loading &&
                      reviews?.length === 0 &&
                      !reviewSubmissionSuccess
                    "
                    class="review-form-header"
                  >
                    <h4>Be the first to review "{{ product.name }}"</h4>
                    <p class="required-note">
                      Your email address will not be published. Required fields
                      are marked *
                    </p>
                  </div>

                  <!-- Review Form -->
                  <form
                    [formGroup]="reviewForm"
                    (ngSubmit)="onSubmitReview()"
                    class="review-form"
                  >
                    <!-- Rating Section -->
                    <div class="form-group">
                      <label for="rating">Your rating *</label>
                      <div class="star-rating">
                        <span
                          *ngFor="let star of [1, 2, 3, 4, 5]"
                          class="star-input"
                          [class.filled]="
                            reviewForm.get('rating')?.value >= star
                          "
                          (click)="setRating(star)"
                        >
                          ★
                        </span>
                      </div>
                      <div
                        *ngIf="
                          reviewForm.get('rating')?.invalid &&
                          reviewForm.get('rating')?.touched
                        "
                        class="error-message"
                      >
                        Please select a rating
                      </div>
                    </div>

                    <!-- Comment Section -->
                    <div class="form-group">
                      <label for="comment">Your review *</label>
                      <textarea
                        id="comment"
                        formControlName="comment"
                        rows="5"
                        placeholder="Write your review here..."
                        class="form-control"
                      >
                      </textarea>
                      <div
                        *ngIf="
                          reviewForm.get('comment')?.invalid &&
                          reviewForm.get('comment')?.touched
                        "
                        class="error-message"
                      >
                        <span
                          *ngIf="reviewForm.get('comment')?.errors?.['required']"
                          >Review comment is required</span
                        >
                        <span
                          *ngIf="reviewForm.get('comment')?.errors?.['minlength']"
                          >Review must be at least 5 characters</span
                        >
                        <span
                          *ngIf="reviewForm.get('comment')?.errors?.['maxlength']"
                          >Review must not exceed 500 characters</span
                        >
                      </div>
                    </div>

                    <!-- Name and Email Row -->
                    <div class="form-row">
                      <div class="form-group half-width">
                        <label for="name">Name *</label>
                        <input
                          type="text"
                          id="name"
                          formControlName="name"
                          class="form-control"
                          placeholder="Your name"
                        />
                        <div
                          *ngIf="
                            reviewForm.get('name')?.invalid &&
                            reviewForm.get('name')?.touched
                          "
                          class="error-message"
                        >
                          <span
                            *ngIf="reviewForm.get('name')?.errors?.['required']"
                            >Name is required</span
                          >
                          <span
                            *ngIf="reviewForm.get('name')?.errors?.['minlength']"
                            >Name must be at least 2 characters</span
                          >
                        </div>
                      </div>

                      <div class="form-group half-width">
                        <label for="email">Email *</label>
                        <input
                          type="email"
                          id="email"
                          formControlName="email"
                          class="form-control"
                          placeholder="Your email"
                        />
                        <div
                          *ngIf="
                            reviewForm.get('email')?.invalid &&
                            reviewForm.get('email')?.touched
                          "
                          class="error-message"
                        >
                          <span
                            *ngIf="reviewForm.get('email')?.errors?.['required']"
                            >Email is required</span
                          >
                          <span
                            *ngIf="reviewForm.get('email')?.errors?.['email']"
                            >Please enter a valid email</span
                          >
                        </div>
                      </div>
                    </div>

                    <!-- Save Info Checkbox -->
                    <div class="form-group">
                      <label class="checkbox-label">
                        <input type="checkbox" formControlName="saveInfo" />
                        Save my name, email, and website in this browser for the
                        next time I comment.
                      </label>
                    </div>

                    <!-- Error Message -->
                    <div *ngIf="reviewSubmissionError" class="error-message">
                      {{ reviewSubmissionError }}
                    </div>

                    <!-- Submit Button -->
                    <button
                      type="submit"
                      class="submit-btn"
                      [disabled]="submittingReview || reviewForm.invalid"
                    >
                      <span *ngIf="submittingReview">Submitting...</span>
                      <span *ngIf="!submittingReview">Submit</span>
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Related Products -->
    <div class="related-products" *ngIf="relatedProducts.length > 0">
      <h3 class="section-title">Related products</h3>
      <div class="related-products-grid">
        <app-product-card
          *ngFor="let relatedProduct of relatedProducts"
          [product]="relatedProduct"
        >
        </app-product-card>
      </div>
    </div>
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading product...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="error-state">
      <p>{{ error }}</p>
      <button (click)="goBack()" class="back-btn">Back to Products</button>
    </div>
  </div>
</div>
