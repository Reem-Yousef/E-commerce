<div class="_Checkout">
  <div class="container-fluid">
    <div class="_CheckoutTitle">
      <h3>Checkout</h3>
    </div>
    <div class="checkout-container">
      <h5 class="coupon-header">
        Have a coupon?
        <span
          href="#"
          (click)="toggleCouponInput(); $event.preventDefault()"
          class="coupon-link"
        >
          Click here to enter your code
        </span>
      </h5>
    </div>

    <div *ngIf="showCouponInput" class="_Coupon">
      <input
        id="coupon"
        type="text"
        [(ngModel)]="couponCode"
        placeholder="Coupon code"
        class="form-control"
        style="min-width: 150px; max-width: 300px; flex-grow: 1"
      />
      <div class="_BtnShop">
        <button class="" (click)="applyCoupon()">Apply coupon</button>
      </div>
    </div>

    <!-- Error Message Display -->
    <div *ngIf="errorMessage" class="alert alert-danger mt-3">
      <i class="bi bi-exclamation-circle me-2"></i>
      {{ errorMessage }}
    </div>

    <div class="row mx-0 _FormContent">
      <div class="col-lg-1 d-none d-lg-block"></div>

      <div class="col-lg-12 col-12 px-lg-3 px-md-2 px-sm-1">
        <div class="row">
          <div class="col-lg-7 col-md-12 order-lg-1 order-2">
            <div class="card shadow-sm border h-100 p-3">
              <div
                class="card-header fs-5 fw-bold bg-white"
                style="color: #88ad35"
              >
                Billing Details
              </div>
              <form
                #billingForm="ngForm"
                class="card-body"
                (ngSubmit)="validateAndProceed(billingForm)"
              >
                <div class="row g-3">
                  <div class="col-md-6 col-12">
                    <label class="form-label">First Name *</label>
                    <input
                      type="text"
                      class="form-control rounded-0"
                      required
                      [(ngModel)]="billing.firstName"
                      name="firstName"
                      #firstName="ngModel"
                    />
                    <div
                      *ngIf="firstName.invalid && firstName.touched"
                      class="text-danger"
                    >
                      First name is required.
                    </div>
                  </div>

                  <div class="col-md-6 col-12">
                    <label class="form-label">Last Name *</label>
                    <input
                      type="text"
                      class="form-control rounded-0"
                      required
                      [(ngModel)]="billing.lastName"
                      name="lastName"
                      #lastName="ngModel"
                    />
                    <div
                      *ngIf="lastName.invalid && lastName.touched"
                      class="text-danger"
                    >
                      Last name is required.
                    </div>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Company Name (optional)</label>
                    <input
                      type="text"
                      class="form-control rounded-0"
                      [(ngModel)]="billing.companyName"
                      name="companyName"
                    />
                  </div>

                  <div class="col-md-6 col-12">
                    <label class="form-label">Country / Region *</label>
                    <select
                      class="form-select rounded-0"
                      required
                      [(ngModel)]="billing.country"
                      name="country"
                      #country="ngModel"
                    >
                      <option value="" disabled selected>Choose country</option>
                      <option>United States</option>
                      <option>Canada</option>
                      <option>UK</option>
                    </select>
                    <div
                      *ngIf="country.invalid && country.touched"
                      class="text-danger"
                    >
                      Country is required.
                    </div>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Street Address *</label>
                    <input
                      type="text"
                      class="form-control rounded-0"
                      required
                      [(ngModel)]="billing.streetAddress"
                      name="streetAddress"
                      #streetAddress="ngModel"
                    />
                    <div
                      *ngIf="streetAddress.invalid && streetAddress.touched"
                      class="text-danger"
                    >
                      Street Address is required.
                    </div>
                  </div>

                  <div class="col-12">
                    <label class="form-label"
                      >Apartment / Suite (optional)</label
                    >
                    <input
                      type="text"
                      class="form-control rounded-0"
                      [(ngModel)]="billing.apartment"
                      name="apartment"
                    />
                  </div>

                  <div class="col-md-6 col-12">
                    <label class="form-label">City *</label>
                    <input
                      type="text"
                      class="form-control rounded-0"
                      required
                      [(ngModel)]="billing.city"
                      name="city"
                      #city="ngModel"
                    />
                    <div
                      *ngIf="city.invalid && city.touched"
                      class="text-danger"
                    >
                      City is required.
                    </div>
                  </div>

                  <div class="col-md-3 col-6">
                    <label class="form-label">State *</label>
                    <input
                      type="text"
                      class="form-control rounded-0"
                      required
                      [(ngModel)]="billing.state"
                      name="state"
                      #state="ngModel"
                    />
                    <div
                      *ngIf="state.invalid && state.touched"
                      class="text-danger"
                    >
                      State is required.
                    </div>
                  </div>

                  <div class="col-md-3 col-6">
                    <label class="form-label">ZIP Code *</label>
                    <input
                      type="text"
                      class="form-control rounded-0"
                      required
                      [(ngModel)]="billing.zip"
                      name="zip"
                      #zip="ngModel"
                    />
                    <div *ngIf="zip.invalid && zip.touched" class="text-danger">
                      ZIP Code is required.
                    </div>
                  </div>

                  <div class="col-md-6 col-12">
                    <label class="form-label">Phone *</label>
                    <input
                      type="tel"
                      class="form-control rounded-0"
                      required
                      [(ngModel)]="billing.phone"
                      name="phone"
                      #phone="ngModel"
                    />
                    <div
                      *ngIf="phone.invalid && phone.touched"
                      class="text-danger"
                    >
                      Phone is required.
                    </div>
                  </div>

                  <div class="col-md-6 col-12">
                    <label class="form-label">Email Address *</label>
                    <input
                      type="email"
                      class="form-control rounded-0"
                      required
                      [(ngModel)]="billing.email"
                      name="email"
                      #email="ngModel"
                    />
                    <div
                      *ngIf="email.invalid && email.touched"
                      class="text-danger"
                    >
                      Valid email is required.
                    </div>
                  </div>

                  <div class="col-12">
                    <strong>Additional information</strong>
                    <hr />
                    <label class="form-label">Order Notes (optional)</label>
                    <textarea
                      class="form-control rounded-0"
                      rows="3"
                      [(ngModel)]="billing.notes"
                      name="notes"
                    ></textarea>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="col-lg-5 col-md-12 order-lg-2 order-1 mb-3 mb-lg-0">
            <div class="card shadow-sm border sticky-top p-3" style="top: 20px">
              <div
                class="card-header bg-white text-black fs-5 fw-bold border-bottom"
                style="border-color: #d3d3d3"
              >
                Your Order
              </div>
              <div class="card-body">
                <table class="table mb-4">
                  <thead>
                    <tr>
                      <th class="border-1">Product</th>
                      <th class="border-1 text-end">Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let product of items">
                      <td class="border-1">
                        {{ product.name }} × {{ product.quantity }}
                      </td>
                      <td class="border-1 text-end">
                        ₹{{ product.price * product.quantity }}
                      </td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr>
                      <td class="border-1 pt-3">Subtotal</td>
                      <td class="border-1 pt-3 text-end">₹{{ subtotal }}</td>
                    </tr>
                    <tr *ngIf="shipping > 0">
                      <td class="border-1">Shipping</td>
                      <td class="border-1 text-end">₹{{ shipping }}</td>
                    </tr>
                    <tr>
                      <td class="border-1">Total</td>
                      <td class="border-1 text-end fw-bold">₹{{ total }}</td>
                    </tr>
                  </tfoot>
                </table>

                <!-- Payment buttons -->
                <div class="d-grid gap-2">
                  <!-- Stripe Payment Button -->
                  <button 
                    type="button" 
                    class="btn btn-success btn-lg" 
                    style="background-color: #88ad35"
                    (click)="processPaymentWithValidation(billingForm)" 
                    [disabled]="isProcessingStripe || !allProductsAvailable">
                    <i class="bi bi-credit-card me-2"></i>
                    {{ isProcessingStripe ? 'Processing...' : 'Pay with Stripe' }}
                  </button>

                  <!-- Order without payment button -->
                  <div class="_BtnShop">
                    <button
                      type="button"
                      (click)="validateAndProceed(billingForm)"
                      [disabled]="isProcessingOrder">
                      <i class="bi bi-check-circle me-2"></i>
                      {{ isProcessingOrder ? 'Processing...' : 'Place Order (No Payment)' }}
                    </button>
                  </div>
                </div>

                <!-- Info message -->
                <div
                  class="alert alert-info bg-light p-3 mt-3 border"
                  style="border-top: 2px solid #88ad35 !important"
                >
                  <i class="bi bi-info-circle me-2"></i>
                  Choose "Pay with Stripe" for immediate payment, or "Place Order" to place order without payment.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-1 d-none d-lg-block"></div>
    </div>
  </div>
</div>